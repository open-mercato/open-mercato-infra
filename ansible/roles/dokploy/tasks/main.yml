---
# Main tasks for Dokploy installation

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: dokploy_system_update_cache | default(true)
  tags:
    - packages

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: dist
    autoremove: true
  when: dokploy_system_upgrade_packages | default(true)
  tags:
    - packages

- name: Install required system packages
  ansible.builtin.apt:
    name: "{{ system_packages }}"
    state: present
  register: dokploy_packages_installed
  tags:
    - packages

- name: Configure UFW - Set default incoming policy
  community.general.ufw:
    direction: incoming
    policy: "{{ ufw_default_incoming_policy }}"
  when: dokploy_configure_ufw | default(true)
  tags:
    - firewall

- name: Configure UFW - Set default outgoing policy
  community.general.ufw:
    direction: outgoing
    policy: "{{ ufw_default_outgoing_policy }}"
  when: dokploy_configure_ufw | default(true)
  tags:
    - firewall

- name: Configure UFW - Allow required ports
  community.general.ufw:
    rule: allow
    port: "{{ item.port | string }}"
    proto: "{{ item.proto }}"
    comment: "{{ item.comment }}"
  loop: "{{ ufw_allowed_ports_initial }}"
  when: dokploy_configure_ufw | default(true)
  tags:
    - firewall

- name: Enable UFW
  community.general.ufw:
    state: enabled
  when: dokploy_configure_ufw | default(true) and dokploy_ufw_enabled | default(true)
  notify: Reload UFW
  tags:
    - firewall

- name: Check if Docker is installed
  ansible.builtin.command: docker --version
  register: dokploy_docker_check
  changed_when: false
  failed_when: false
  tags:
    - docker

- name: Display Docker status
  ansible.builtin.debug:
    msg: "Docker status: {{ 'Installed (' + dokploy_docker_check.stdout + ')' if dokploy_docker_check.rc == 0 else 'Not installed - will install' }}"
  tags:
    - docker

# Docker Installation (official method for Ubuntu)
- name: Remove old Docker packages
  ansible.builtin.apt:
    name:
      - docker.io
      - docker-doc
      - docker-compose
      - docker-compose-v2
      - podman-docker
      - containerd
      - runc
    state: absent
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Install Docker prerequisites
  ansible.builtin.apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present
    update_cache: true
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Create Docker keyring directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Download Docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/ubuntu/gpg
    dest: /etc/apt/keyrings/docker.asc
    mode: "0644"
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Get system architecture
  ansible.builtin.command: dpkg --print-architecture
  register: dokploy_system_arch
  changed_when: false
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Get Ubuntu codename
  ansible.builtin.command: bash -c ". /etc/os-release && echo $VERSION_CODENAME"
  register: dokploy_ubuntu_codename
  changed_when: false
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Add Docker repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [arch={{ dokploy_system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc]
      https://download.docker.com/linux/ubuntu {{ dokploy_ubuntu_codename.stdout }} stable
    state: present
    filename: docker
  when: dokploy_docker_check.rc != 0
  tags:
    - docker

- name: Install Docker packages
  ansible.builtin.apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present
    update_cache: true
  when: dokploy_docker_check.rc != 0
  notify: Restart Docker
  tags:
    - docker

- name: Ensure Docker service is started and enabled
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true
  tags:
    - docker

- name: Verify Docker installation
  ansible.builtin.command: docker run --rm hello-world
  register: dokploy_docker_hello
  changed_when: false
  failed_when: false
  tags:
    - docker
    - verification

- name: Display Docker verification result
  ansible.builtin.debug:
    msg: "{{ 'Docker is working correctly' if dokploy_docker_hello.rc == 0 else 'Docker installation may have issues' }}"
  tags:
    - docker
    - verification

- name: Check if Dokploy is already installed
  ansible.builtin.command: docker ps -a --filter "name=dokploy" --format "{{ '{{' }}.Names{{ '}}' }}"
  register: dokploy_check
  changed_when: false
  failed_when: false
  tags:
    - dokploy

- name: Display Dokploy installation status
  ansible.builtin.debug:
    msg: "Dokploy container status: {{ 'Already installed' if dokploy_check.stdout | length > 0 else 'Not installed' }}"
  tags:
    - dokploy

- name: Download Dokploy installation script
  ansible.builtin.get_url:
    url: "{{ dokploy_install_script_url }}"
    dest: /tmp/dokploy-install.sh
    mode: "0755"
    checksum: "{{ 'sha256:' + dokploy_install_script_checksum if dokploy_install_script_checksum | default('') | length > 0 else omit }}"
  when: dokploy_check.stdout | length == 0
  tags:
    - dokploy

- name: Warn if checksum verification is disabled
  ansible.builtin.debug:
    msg: "WARNING: Dokploy install script checksum verification is disabled. Consider setting dokploy_install_script_checksum for production use."
  when:
    - dokploy_check.stdout | length == 0
    - dokploy_install_script_checksum | default('') | length == 0
  tags:
    - dokploy

- name: Install Dokploy
  ansible.builtin.shell: |
    set -o pipefail
    /tmp/dokploy-install.sh
  args:
    executable: /bin/bash
  register: dokploy_install
  when: dokploy_check.stdout | length == 0
  changed_when: dokploy_install.rc == 0
  tags:
    - dokploy

- name: Wait for Dokploy to start
  ansible.builtin.uri:
    url: "http://localhost:{{ dokploy_dashboard_port }}"
    method: GET
    status_code: [200, 302, 301]
  register: dokploy_health
  until: dokploy_health.status in [200, 302, 301]
  retries: 30
  delay: 10
  when: dokploy_check.stdout | length == 0 or dokploy_install is changed
  tags:
    - dokploy

- name: Verify Dokploy is running
  ansible.builtin.command: docker ps --filter "name=dokploy" --format "{{ '{{' }}.Status{{ '}}' }}"
  register: dokploy_status
  changed_when: false
  tags:
    - dokploy
    - verification

- name: Display Dokploy status
  ansible.builtin.debug:
    msg: |
      ============================================
      Dokploy Installation Complete!
      ============================================
      Dashboard URL: http://{{ ansible_host }}:{{ dokploy_dashboard_port }}
      Container Status: {{ dokploy_status.stdout }}

      Next Steps:
      1. Access the dashboard URL above
      2. Create your admin account
      3. Configure your domain in Settings -> Web Server
      4. After domain setup, run the security hardening playbook
      ============================================
  tags:
    - dokploy
    - verification

- name: Clean up installation script
  ansible.builtin.file:
    path: /tmp/dokploy-install.sh
    state: absent
  tags:
    - dokploy
