---
# Security hardening tasks - Run AFTER domain is configured in Dokploy

- name: Confirm domain is configured
  ansible.builtin.pause:
    prompt: |
      ============================================
      IMPORTANT: Before proceeding, ensure that:
      1. You have configured your domain in Dokploy UI
      2. SSL certificates are working (HTTPS access)
      3. You can access Dokploy via your domain

      Press ENTER to continue or Ctrl+C to abort...
      ============================================
  when: not (skip_confirmation | default(false))
  tags:
    - always

- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    state: present
    update_cache: true
  when: install_fail2ban | default(true)
  tags:
    - fail2ban

- name: Configure fail2ban jail.local
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: "0644"
  notify: Restart fail2ban
  when: install_fail2ban | default(true)
  tags:
    - fail2ban

- name: Enable and start fail2ban
  ansible.builtin.service:
    name: fail2ban
    state: started
    enabled: true
  when: install_fail2ban | default(true)
  tags:
    - fail2ban

- name: Install iptables-persistent for rule persistence
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive
  when: security_hardening_remove_dashboard_port | default(true)
  tags:
    - firewall

- name: Block external access to Dokploy dashboard port (DOCKER-USER chain)
  ansible.builtin.iptables:
    chain: DOCKER-USER
    protocol: tcp
    destination_port: "{{ dokploy_dashboard_port }}"
    jump: DROP
    action: insert
    rule_num: 1
  when: security_hardening_remove_dashboard_port | default(true)
  notify: Save iptables rules
  tags:
    - firewall

- name: Allow localhost access to Dokploy dashboard port (insert before DROP)
  ansible.builtin.iptables:
    chain: DOCKER-USER
    protocol: tcp
    destination_port: "{{ dokploy_dashboard_port }}"
    source: 127.0.0.1
    jump: ACCEPT
    action: insert
    rule_num: 1
  when: security_hardening_remove_dashboard_port | default(true)
  notify: Save iptables rules
  tags:
    - firewall

- name: Allow Docker network access to Dokploy dashboard port (for internal services)
  ansible.builtin.iptables:
    chain: DOCKER-USER
    protocol: tcp
    destination_port: "{{ dokploy_dashboard_port }}"
    source: 172.16.0.0/12
    jump: ACCEPT
    action: insert
    rule_num: 1
  when: security_hardening_remove_dashboard_port | default(true)
  notify: Save iptables rules
  tags:
    - firewall

- name: Verify iptables DOCKER-USER chain rules
  ansible.builtin.command: iptables -L DOCKER-USER -n -v --line-numbers
  register: security_hardening_iptables_status
  changed_when: false
  tags:
    - firewall
    - verification

- name: Display iptables DOCKER-USER rules
  ansible.builtin.debug:
    msg: "{{ security_hardening_iptables_status.stdout_lines }}"
  tags:
    - firewall
    - verification

- name: Configure SSH - Disable password authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication"
    line: "PasswordAuthentication {{ security_hardening_ssh_password_authentication }}"
    state: present
  notify: Restart SSH
  tags:
    - ssh

- name: Configure SSH - Enable pubkey authentication
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PubkeyAuthentication"
    line: "PubkeyAuthentication {{ security_hardening_ssh_pubkey_authentication }}"
    state: present
  notify: Restart SSH
  tags:
    - ssh

- name: Configure SSH - Root login setting
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin"
    line: "PermitRootLogin {{ security_hardening_ssh_permit_root_login }}"
    state: present
  notify: Restart SSH
  tags:
    - ssh

- name: Configure SSH - Disable X11 forwarding
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?X11Forwarding"
    line: "X11Forwarding no"
    state: present
  notify: Restart SSH
  tags:
    - ssh

- name: Configure SSH - Limit authentication attempts
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?MaxAuthTries"
    line: "MaxAuthTries 3"
    state: present
  notify: Restart SSH
  tags:
    - ssh

- name: Apply sysctl hardening settings
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop:
    - { name: "net.ipv4.ip_forward", value: "1" }
    - { name: "net.ipv4.conf.all.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.send_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.default.accept_redirects", value: "0" }
    - { name: "net.ipv4.conf.all.accept_source_route", value: "0" }
    - { name: "net.ipv4.conf.default.accept_source_route", value: "0" }
  when: security_hardening_apply_sysctl_hardening | default(true)
  tags:
    - sysctl

- name: Display security hardening completion message
  ansible.builtin.debug:
    msg: |
      ============================================
      Security Hardening Complete!
      ============================================
      - Fail2ban: {{ 'Installed and configured' if install_fail2ban else 'Skipped' }}
      - Port 3000: {{ 'Blocked via iptables DOCKER-USER chain' if security_hardening_remove_dashboard_port else 'Still open' }}
      - SSH: Password auth disabled, pubkey required
      - SSH: X11 forwarding disabled, max auth tries limited
      - Sysctl: Network hardening applied

      Your Dokploy instance is now accessible only via:
      - Your configured domain (HTTPS)
      - SSH on port 22

      The dashboard port 3000 is blocked for external access.
      Internal Docker services can still reach it.
      ============================================
  tags:
    - verification
